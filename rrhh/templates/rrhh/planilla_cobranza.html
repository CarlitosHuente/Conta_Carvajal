{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ðŸ“Š Control de Cobranza</h2>
        
        <div class="d-flex align-items-center gap-3">
            <form method="get" class="d-flex align-items-center">
                <label class="me-2 fw-bold">AÃ±o:</label>
                <select name="anio" onchange="this.form.submit()" class="form-select form-select-sm">
                    {% for a in anios_opciones %}
                        <option value="{{ a }}" {% if a == anio_sel %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </form>
            <a href="{% url 'admin:rrhh_registrocobro_add' %}" class="btn btn-success btn-sm">
                <i class="fas fa-plus"></i> Registrar Cobro
            </a>
        </div>
    </div>

    <table class="table table-bordered table-sm bg-white shadow-sm">
        <thead class="table-dark">
            <tr>
                <th class="ps-3">Empresa</th>
                {% for m in meses %}<th>M{{ m }}</th>{% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for empresa in empresas %}
            <tr>
                <td class="fw-bold ps-3">{{ empresa.razon_social }}</td>
                {% for m in meses %}
                <td class="text-center p-1">
                    {% for c in empresa.cobros.all %}
                        {% if c.mes == m %}
                            <button class="btn btn-sm w-100 {% if c.pagado %}btn-success{% else %}btn-danger{% endif %}" 
                                    data-bs-toggle="popover" 
                                    data-bs-trigger="focus"
                                    data-bs-html="true"
                                    title="Detalle Pago Mes {{ m }} - {{ c.ano }}"
                                    data-bs-content="<strong>BH NÂ°:</strong> {{ c.nro_bh_emitida }}<br><strong>Monto UF:</strong> {{ c.monto_uf }}<br><strong>UF Aplicada:</strong> ${{ c.valor_uf_aplicado }}<br><strong>Pago:</strong> {{ c.fecha_pago|date:'d/m/Y' }}">
                                ${{ c.total_pesos }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% block javascript %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl, {
                html: true,
                sanitize: false
            })
        })
    });
</script>
{% endblock %}
{% endblock %}