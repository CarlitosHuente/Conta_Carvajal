{% extends 'base.html' %}
{% block title %}Añadir Indicadores del Período{% endblock %}

{% block content %}
<h2>Añadir Indicadores del Período</h2>
<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            {{ form.non_field_errors }}

            <fieldset class="mb-4">
                <legend class="fs-5 border-bottom mb-3">Valores del Período</legend>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="{{ form.mes.id_for_label }}" class="form-label">Mes</label>
                        {{ form.mes }}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ form.ano.id_for_label }}" class="form-label">Año</label>
                        {{ form.ano }}
                    </div>
                    <div class="col-md-6">
                        </div>
                    <div class="col-md-4">
                        <label for="{{ form.uf.id_for_label }}" class="form-label">Valor UF ($)</label>
                        {{ form.uf }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.utm.id_for_label }}" class="form-label">Valor UTM ($)</label>
                        {{ form.utm }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.sueldo_minimo.id_for_label }}" class="form-label">Sueldo Mínimo ($)</label>
                        {{ form.sueldo_minimo }}
                    </div>
                </div>
            </fieldset>

            <fieldset class="mb-4">
                <legend class="fs-5 border-bottom mb-3">Topes Imponibles y Tasas</legend>
                <div class="row g-3 align-items-center">
                    <div class="col-md-3">
                        <label for="{{ form.tope_imponible_afp_uf.id_for_label }}" class="form-label">Tope AFP (UF)</label>
                        {{ form.tope_imponible_afp_uf }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tope AFP ($) (Calculado)</label>
                        {{ form.tope_imponible_afp_pesos }}
                    </div>
                </div>
                <div class="row g-3 align-items-center mt-2">
                    <div class="col-md-3">
                        <label for="{{ form.tope_imponible_cesantia_uf.id_for_label }}" class="form-label">Tope Seg. Cesantía (UF)</label>
                        {{ form.tope_imponible_cesantia_uf }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tope Seg. Cesantía ($) (Calculado)</label>
                        {{ form.tope_imponible_cesantia_pesos }}
                    </div>
                </div>
                 <div class="row g-3 align-items-center mt-2">
                     <div class="col-md-3">
                        <label for="{{ form.tasa_sis.id_for_label }}" class="form-label">Tasa SIS (%)</label>
                        {{ form.tasa_sis }}
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend class="fs-5 border-bottom mb-3">Asignación Familiar</legend>
                <table class="table table-bordered" style="max-width: 800px;">
                    <thead class="table-light">
                        <tr>
                            <th>Tramo</th>
                            <th>Monto Beneficio ($)</th>
                            <th>Límite Ingreso ($)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="align-middle"><strong>Tramo A</strong></td>
                            <td>{{ form.asig_familiar_tramo_a_monto }}</td>
                            <td>{{ form.asig_familiar_tramo_a_limite }}</td>
                        </tr>
                        <tr>
                            <td class="align-middle"><strong>Tramo B</strong></td>
                            <td>{{ form.asig_familiar_tramo_b_monto }}</td>
                            <td>{{ form.asig_familiar_tramo_b_limite }}</td>
                        </tr>
                        <tr>
                            <td class="align-middle"><strong>Tramo C</strong></td>
                            <td>{{ form.asig_familiar_tramo_c_monto }}</td>
                            <td>{{ form.asig_familiar_tramo_c_limite }}</td>
                        </tr>
                    </tbody>
                </table>
            </fieldset>

            <hr>
            <a href="{% url 'rrhh:indicador_list' %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar Período</button>
        </form>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Referencias a los campos del formulario
    const ufInput = document.getElementById('{{ form.uf.id_for_label }}');
    
    const afpUfInput = document.getElementById('{{ form.tope_imponible_afp_uf.id_for_label }}');
    const afpPesosInput = document.getElementById('{{ form.tope_imponible_afp_pesos.id_for_label }}');
    
    const cesantiaUfInput = document.getElementById('{{ form.tope_imponible_cesantia_uf.id_for_label }}');
    const cesantiaPesosInput = document.getElementById('{{ form.tope_imponible_cesantia_pesos.id_for_label }}');

    // Función para calcular y actualizar los topes
    function calcularTopes() {
        const ufValor = parseFloat(ufInput.value.replace(',', '.')) || 0;
        
        // Calcular Tope AFP
        const afpUfValor = parseFloat(afpUfInput.value.replace(',', '.')) || 0;
        const afpPesosCalculado = (ufValor * afpUfValor).toFixed(0);
        afpPesosInput.value = afpPesosCalculado;

        // Calcular Tope Cesantía
        const cesantiaUfValor = parseFloat(cesantiaUfInput.value.replace(',', '.')) || 0;
        const cesantiaPesosCalculado = (ufValor * cesantiaUfValor).toFixed(0);
        cesantiaPesosInput.value = cesantiaPesosCalculado;
    }

    // --- EVENT LISTENERS ---
    // Escuchamos cuando el usuario cambia el valor de la UF
    ufInput.addEventListener('input', calcularTopes);
    // Escuchamos si cambia el valor en UF del tope AFP
    afpUfInput.addEventListener('input', calcularTopes);
    // Escuchamos si cambia el valor en UF del tope de Cesantía
    cesantiaUfInput.addEventListener('input', calcularTopes);

    // Calculamos los valores una vez al cargar la página
    // Esto es útil por si el formulario viene precargado
    calcularTopes();
});
</script>
{% endblock %}